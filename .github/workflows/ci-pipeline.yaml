name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build Frontend Container
        run: |
          docker build -t my-frontend-image:latest ./frontend
          
      - name: Run Frontend Unit Tests
        run: |
          docker run --rm my-frontend-image:latest npm test || true # Run tests; continue even if they fail

      - name: Lint Frontend Code
        run: |
          docker run --rm my-frontend-image:latest npm run lint

  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build Backend Container
        run: |
          docker build -t my-backend-image:latest ./backend

      - name: Run Backend Unit Tests
        run: |
          docker run --rm my-backend-image:latest npm test || true # Run tests; continue even if they fail

      - name: Lint Backend Code
        run: |
          docker run --rm my-backend-image:latest npm run lint

  push-images:
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend]
    steps:
      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Push Frontend Image
        run: |
          docker tag my-frontend-image:latest mydockerhubusername/my-frontend-image:latest
          docker push mydockerhubusername/my-frontend-image:latest

      - name: Push Backend Image
        run: |
          docker tag my-backend-image:latest mydockerhubusername/my-backend-image:latest
          docker push mydockerhubusername/my-backend-image:latest

  cache:
    runs-on: ubuntu-latest
    steps:
      - name: Cache Node Modules
        uses: actions/cache@v2
        with:
          path: ./frontend/node_modules
          key: ${{ runner.os }}-frontend-${{ hashFiles('**/frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-
      
      - name: Cache Node Modules (Backend)
        uses: actions/cache@v2
        with:
          path: ./backend/node_modules
          key: ${{ runner.os }}-backend-${{ hashFiles('**/backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-


